# Option 1

#!/bin/bash
#PBS -P ProjectName
#PBS -N JobName
#PBS -q P_Queue 
#PBS -l ncpus=32
#PBS -l mem=1GB
#PBS -l walltime=1:00:00
#PBS -J 0-31  # Set job array index range based on the number of files and target values (sys.argv[1])
#PBS -o output_%A_%a.out  # Output file 
#PBS -e error_%A_%a.err   # Error file 
#PBS -M j_m289@student.usc.edu.au
#PBS -m abe

module load python/3.11
source /ProjectName/idtxl_env/bin/activate # Adjust based on container

ROOT_DIR=/path/to/bids/data # Adjust based on container # (sys.argv[2])

# Get list of subject IDs and sessions from BIDS structure
SUBJECTS=$(find $ROOT_DIR -mindepth 1 -maxdepth 1 -type d -name 'sub-*' | sed 's/.*\///') # (sys.argv[3])
SESSIONS=$(find $ROOT_DIR -mindepth 2 -maxdepth 2 -type d -name 'ses-*' | sed 's/.*\///') # (sys.argv[4])

# Calculate the number of files based on the number of subjects and sessions
NUM_FILES=$(($(echo "$SUBJECTS" | wc -w) * $(echo "$SESSIONS" | wc -w)))

# Calculate the current file and target value based on the job array index
TASK_INDEX=$((PBS_ARRAY_INDEX))
FILE_INDEX=$((TASK_INDEX / 32 + 1))
TARGET_INDEX=$((TASK_INDEX % 32))

# Get the current subject and session based on the file index
SUBJECT=$(echo "$SUBJECTS" | awk -v idx=$FILE_INDEX 'NR==idx {print $1}')
SESSION=$(echo "$SESSIONS" | awk -v idx=$(((FILE_INDEX-1) % $(echo "$SESSIONS" | wc -w) + 1)) 'NR==idx {print $1}')

FILE_DIR=$ROOT_DIR/$SUBJECT/$SESSION

# Run the analysis script with the current target value and file directory
python analyse_single_target_HPC.py $TARGET_INDEX $FILE_DIR $SUBJECT $SESSION

# Option 2
#!/bin/bash
#PBS -P ProjectName
#PBS -N JobName
#PBS -q P_Queue 
#PBS -l ncpus=32
#PBS -l mem=1GB
#PBS -l walltime=1:00:00
#PBS -J 0-31  # Set job array index range based on the number of files and target values (sys.argv[1])
#PBS -o output_%A_%a.out  # Output file 
#PBS -e error_%A_%a.err   # Error file 
#PBS -M j_m289@student.usc.edu.au
#PBS -m abe

module load python/3.11
source /ProjectName/idtxl_env/bin/activate

ROOT_DIR=/path/to/bids/data

SUBJECTS=$(find $ROOT_DIR -mindepth 1 -maxdepth 1 -type d -name 'sub-*' | sed 's/.*\///')
SESSIONS=$(find $ROOT_DIR -mindepth 2 -maxdepth 2 -type d -name 'ses-*' | sed 's/.*\///')

NUM_FILES=0
for sub in $SUBJECTS; do
    for ses in $SESSIONS; do
        NUM_FILES=$((NUM_FILES + 1))
    done
done

TASK_INDEX=$((PBS_ARRAY_INDEX))
FILE_INDEX=$((TASK_INDEX / 32 + 1))
TARGET_INDEX=$((TASK_INDEX % 32))

SUBJECT=$(echo "$SUBJECTS" | awk -v idx=$FILE_INDEX 'NR==idx {print $1}')
SESSION=$(echo "$SESSIONS" | awk -v idx=$(((FILE_INDEX-1) % $(echo "$SESSIONS" | wc -w) + 1)) 'NR==idx {print $1}')

FILE_DIR=$ROOT_DIR/$SUBJECT/$SESSION

python analyse_single_target_HPC.py $TARGET_INDEX $FILE_DIR $SUBJECT $SESSION --ncpus 32