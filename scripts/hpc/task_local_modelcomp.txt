#!/bin/bash
#PBS -N OKTOS_task_local_modelcomp
#PBS -J 0-31
#PBS -q P_queue
#PBS -l select=1:ncpus=24:mem=64gb
#PBS -l walltime=600:00:00
#PBS -j oe
#PBS -m a
#PBS -o logs/oktos_task_local_20250311_^array_index^.log

# Change to the directory where your R script is located
cd /mnt/HPCcache/shared/pschwenn/OKTOS

# Sleep for a few seconds
sleep 2

# Calculate model index (this will give values 0 to 3 for the 0-3 range, 4-7 range, etc.)
model_index=$((PBS_ARRAY_INDEX % 4))

# Determine which task string to pass based on the job array index
if [ $PBS_ARRAY_INDEX -ge 0 ] && [ $PBS_ARRAY_INDEX -le 15 ]; then
    task="AO"
elif [ $PBS_ARRAY_INDEX -ge 16 ] && [ $PBS_ARRAY_INDEX -le 31 ]; then
    task="AXCPT"
else
    echo "Invalid job array index for task"
    exit 1
fi

# Determine which metric string to pass based on the job array index
if [ $PBS_ARRAY_INDEX -ge 0 ] && [ $PBS_ARRAY_INDEX -le 3 ] || [ $PBS_ARRAY_INDEX -ge 16 ] && [ $PBS_ARRAY_INDEX -le 19 ]; then
    metric="Btwn"
elif [ $PBS_ARRAY_INDEX -ge 4 ] && [ $PBS_ARRAY_INDEX -le 7 ] || [ $PBS_ARRAY_INDEX -ge 20 ] && [ $PBS_ARRAY_INDEX -le 23 ]; then
    metric="InDgr"
elif [ $PBS_ARRAY_INDEX -ge 8 ] && [ $PBS_ARRAY_INDEX -le 11 ] || [ $PBS_ARRAY_INDEX -ge 24 ] && [ $PBS_ARRAY_INDEX -le 27 ]; then
    metric="OutDgr"
elif [ $PBS_ARRAY_INDEX -ge 12 ] && [ $PBS_ARRAY_INDEX -le 15 ] || [ $PBS_ARRAY_INDEX -ge 28 ] && [ $PBS_ARRAY_INDEX -le 31 ]; then
    metric="ClCoef"
else
    echo "Invalid job array index for metric"
    exit 1
fi

# Run the R script with the appropriate centrality string
echo "Running R script for sample entropy model comparisons"
/usr/local/bin/singularity exec -B ./:/data /mnt/HPCcache/shared/pschwenn/singularity/ti_r.sif bash -c "cd /data && Rscript ./oktos_task_local_modelcomp.R $task $metric $model_index ./"
